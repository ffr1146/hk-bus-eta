<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>香港巴士 ETA - KMB / 龍運</title>
  <meta name="description" content="簡單查詢香港九巴 / 龍運巴士到站時間 (使用官方開放數據 API)" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ff5722">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://img.icons8.com/fluency/96/bus.png">
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f8f9fa;
      color: #212529;
    }
    h1 { text-align: center; color: #dc3545; margin: 0.8em 0 0.4em; }
    input, select, button {
      display: block;
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 1.1rem;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      box-sizing: border-box;
    }
    button {
      background: #fd7e14;
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: #e66d00; }
    .section {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1rem 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      min-height: 4rem;
    }
    .error { color: #dc3545; font-weight: 500; }
    .eta-item {
      padding: 0.75rem 0;
      border-bottom: 1px solid #eee;
    }
    .eta-item:last-child { border-bottom: none; }
    .time { font-size: 1.5rem; font-weight: bold; color: #c2185b; }
    .dest { color: #495057; margin-left: 0.5rem; }
    .remark { color: #e67e22; font-style: italic; margin-left: 0.5rem; }
    small { color: #6c757d; display: block; margin-top: 0.25rem; }
  </style>
</head>
<body>

  <h1>香港巴士到站時間查詢</h1>
  <p style="text-align:center; color:#6c757d;">支援九巴 / 龍運 (KMB/LWB) – 輸入路線號後選方向再選站</p>

  <input type="text" id="routeInput" placeholder="路線號碼，例如 268C、1、960、E22" autocomplete="off" />

  <button onclick="loadDirections()">查詢方向</button>

  <div id="status" class="section"></div>

  <div id="directionSection" class="section" style="display:none;">
    <label for="directionSelect">選擇方向：</label>
    <select id="directionSelect" onchange="loadStops()">
      <option value="">請選擇方向 / 服務類型</option>
    </select>
  </div>

  <div id="stopSection" class="section" style="display:none;">
    <label for="stopSelect">選擇巴士站：</label>
    <select id="stopSelect" onchange="fetchETA()">
      <option value="">請選擇站點</option>
    </select>
    <div id="etaDisplay"></div>
  </div>

  <script>
    let variants = [];

    async function loadDirections() {
      const input = document.getElementById('routeInput').value.trim();
      const route = input.toUpperCase();
      if (!route) return alert('請輸入路線號碼');

      const status = document.getElementById('status');
      status.innerHTML = `<p>正在搜尋路線 ${route} …</p>`;

      try {
        const res = await fetch('https://data.etabus.gov.hk/v1/transport/kmb/route');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const { data, generated_timestamp } = await res.json();
        variants = data.filter(v => v.route === route);

        if (variants.length === 0) {
          status.innerHTML = `<p class="error">找不到路線 ${route}，請確認輸入（例如 268C 而非 268c）</p>`;
          return;
        }

        status.innerHTML = `<p>找到 ${variants.length} 個方向/服務類型</p>
                            <small>資料更新：${generated_timestamp || '—'}</small>`;

        const sel = document.getElementById('directionSelect');
        sel.innerHTML = '<option value="">請選擇方向 / 服務類型</option>';

        variants.forEach((v, i) => {
          const dir = v.bound === 'O' ? '往外' : '往內';
          const label = `${v.route}　${dir}　${v.orig_tc} → ${v.dest_tc}　(服務 ${v.service_type})`;
          sel.insertAdjacentHTML('beforeend', `<option value="${i}">${label}</option>`);
        });

        document.getElementById('directionSection').style.display = 'block';
        document.getElementById('stopSection').style.display = 'none';

      } catch (err) {
        status.innerHTML = `<p class="error">載入失敗：${err.message}</p>`;
      }
    }

    async function loadStops() {
      const idx = document.getElementById('directionSelect').value;
      if (!idx) return;

      const v = variants[idx];
      const { route, bound, service_type } = v;

      const stopSel = document.getElementById('stopSelect');
      const etaDiv = document.getElementById('etaDisplay');

      stopSel.innerHTML = '<option value="">載入站表中...</option>';
      etaDiv.innerHTML = '';
      document.getElementById('stopSection').style.display = 'block';

      try {
        const url = `https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${route}/${bound}/${service_type}`;
        const res = await fetch(url);

        if (res.status === 422) {
          throw new Error('422 – 該方向/服務類型組合不存在，請試其他方向');
        }
        if (!res.ok) {
          throw new Error(`API 錯誤：${res.status}`);
        }

        const { data } = await res.json();
        if (!data?.length) {
          stopSel.innerHTML = '<option value="">無站點資料</option>';
          return;
        }

        stopSel.innerHTML = '<option value="">請選擇巴士站</option>';
        data.sort((a,b) => a.seq - b.seq).forEach(s => {
          stopSel.insertAdjacentHTML('beforeend', `<option value="${s.stop}">${s.name_tc}</option>`);
        });

        etaDiv.innerHTML = '<p style="color:#6c757d;">請在上方選擇想查詢的巴士站</p>';

      } catch (err) {
        stopSel.innerHTML = '<option value="">載入失敗</option>';
        etaDiv.innerHTML = `<p class="error">${err.message}</p>`;
      }
    }

    async function fetchETA() {
      const stopId = document.getElementById('stopSelect').value;
      if (!stopId) return;

      const div = document.getElementById('etaDisplay');
      div.innerHTML = '<p>查詢中...</p>';

      try {
        const res = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stopId}`);
        if (!res.ok) throw new Error(`ETA 錯誤：${res.status}`);

        const { data } = await res.json();
        if (!data?.length) {
          div.innerHTML = '<p>暫無到站資料</p>';
          return;
        }

        const now = Date.now();
        const future = data
          .filter(e => e.eta)
          .map(e => ({...e, mins: Math.round((new Date(e.eta) - now)/60000) }))
          .filter(e => e.mins > -3)
          .sort((a,b) => a.mins - b.mins);

        let html = `<div style="font-weight:bold; color:#1976d2; margin-bottom:0.5rem;">
                      ${future[0]?.route || '—'} 於 ${future[0]?.dest_tc || '該站'}
                    </div>`;

        let shown = 0;
        for (const e of future) {
          if (shown >= 3) break;
          const t = e.mins > 0 ? `${e.mins} 分` : (e.mins > -3 ? '即將到達' : '已過');
          html += `
            <div class="eta-item">
              <span class="time">${t}</span>
              <span class="dest">往 ${e.dest_tc || e.dest_en}</span>
              ${e.rmk_tc ? `<span class="remark">(${e.rmk_tc})</span>` : ''}
              <small>${e.eta?.slice(11,16) || ''}</small>
            </div>`;
          shown++;
        }

        if (shown === 0) html += '<p>暫無未來班次</p>';
        div.innerHTML = html;

      } catch (err) {
        div.innerHTML = `<p class="error">ETA 查詢失敗：${err.message}</p>`;
      }
    }
  </script>
</body>
</html>